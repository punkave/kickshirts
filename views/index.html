<!DOCTYPE html>
<html>
<head>
  <title>KickShirts</title>
</head>
<link rel="stylesheet" type="text/css" href="main.css">
<body>
  <div class="container">
    <header>
      <h1>KickShirts</h1>
      <h2>Shop for T-shirts by pledging on <a href="http://kickstarter.com/">Kickstarter</a></h2>
      <h4><em><a href="#footer">A P'unk Avenue weekend hack</a></em></h4>
    </header>
    <h3 class="max">
      <a href="#" data-max="0" class="active">No limit</a>
      <a href="#" data-max="10">$10</a>
      <a href="#" data-max="20">$20</a>
      <a href="#" data-max="30">$30</a>
      <a href="#" data-max="50">$50</a>
      <a href="#" data-max="75">$75</a>
      <a href="#" data-max="100">$100</a>
      <em>Currency may vary</em>
    </h3>
    <div class="articles">
      {% include 'views/projects.html' %}
    </div>
    <div class="loading">
      <img src="/spinner.gif"/>
      <img src="/spinner.gif"/>
      <img src="/spinner.gif"/>
      <img src="/spinner.gif"/>
      <img src="/spinner.gif"/>
      <img src="/spinner.gif"/>
      <img src="/spinner.gif"/>
      <img src="/spinner.gif"/>
    </div>
    <a name="footer"></a>
    <footer>
      <a href="http://punkave.com/"><img class="logo" src="punkavelogo.png" /></a>
      <h3>A <a href="http://punkave.com/">P'unk Avenue</a> weekend hack</h3>
      <h4>Idea: Geoff DiMasi</h4>
      <h4>Execution: Tom Boutell</h4>
      <p><em>P'unk Avenue is in no way affiliated with Kickstarter. We love Kickstarter and hope to encourage people to support cool projects.</em></p>
    </footer>
  </div>
  <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.10.2/jquery-ui.min.js"></script>
  <script type="text/javascript">
    $(function() {
      var page = 1;
      var max = 0;
      var end = false;
      var loading = false;

      // Infinite scroll
      setInterval(function() {
        if ((!end) && (!loading)) {
          if (($(document).scrollTop() + $(window).height() + 350) >= $(document).height())
          {
            loadPage();
          }
        }
      }, 100);

      var maxPrice = 0;
      $('body').on('click', '[data-max]', function() {
        max = parseFloat($(this).attr('data-max'));
        $('[data-max]').removeClass('active');
        $(this).addClass('active');
        reset();
        return false;
      });

      function reset() {
        $('.articles').html('');
        page = 0;
        end = false;
        $('.loading').show();
        loadPage();
      }

      function loadPage() {
        page++;
        loading = true;
        $.ajax({
          url: '/projects',
          type: 'GET',
          data: {
            page: page,
            max: max
          },
          success: function(data) {
            var $articles = $.parseHTML(data);
            $('.articles').append($articles);
            enhanceArticles();
            loading = false;
          },
          error: function() {
            loading = false;
          },
          statusCode: {
            404: function() {
              end = true;
              $('.loading').hide();
            }
          }
        });
      }

      enhanceBody();
      enhanceArticles();

      function enhanceBody() {
        var $h1 = $('h1');
        function fade() {
          var color = 'rgb(' + color() + ',' + color() + ',' + color() + ')';
          $h1.animate({ 'color': color }, 1000, fade);
          function color() {
            return Math.floor(Math.random() * 256);
          }
        }
        fade();
      }

      function enhanceArticles() {
        $('.project .desc').each(function() {
          var $desc = $(this);
          if ($desc.data('enhanced')) {
            return;
          }
          var markup = $desc.html();
          markup = markup.replace(/[A-Za-z\-]*shirt/i, function(match) {
            return '<span class="shirt-word">' + match + '</span>';
          });
          $desc.html(markup);
          $desc.data('enhanced', true);
        });
      }
    });
  </script>
</body>
</html>
